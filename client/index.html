
<!DOCTYPE html>
<html lang="en">
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="theme-color" content="#4586ef"/>
<meta name="Description" content="A small JS and HTML5 game about pirates!">

<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>


<body  id="container" style ="margin:0; overflow-x:hidden; overflow-y:hidden;">
    
<title>Seas of Pixel</title>

<div id="page_login"  >

        <label for="login_username">Username :</label>
        <input id="login_username" type="text"></input>

        <button id="login_button">Logga</button>

        <div><input type="checkbox" id="Qlow" name="qualiy low">      <label for="Qlow">Low Quality</label>           </div>
        <div><input type="checkbox" id="Qmed" name="qualiy medium">     <label for="Qmed">Medium Quality</label>      </div>
        <div><input type="checkbox" id="Qhig" name="qualiy high">         <label for="Qhig">High Quality</label>      </div>
        <div><input type="checkbox" id="Qins" name="qualiy insane">  <label for="Qins">Destroy my PC Quality</label>  </div>

</div>


 <div id="page_game"  style="display:none; position:relative;  z-index:0">
    <canvas id="canvas" style="  z-index: 1; position:absolute;" width="640" height="480""></canvas>
</div>


<script src="/client/js/engine.js"></script>

<script src="/client/js/virtualjoystick.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="/client/js/setting.js"></script>
<script src="/client/js/game.js"></script>
<script src="/client/js/load.js"></script>


<script>

    //reindirizza a https
    if(window.location.href == "http://simone-pwa.herokuapp.com/")
    {window.location.replace("https://simone-pwa.herokuapp.com/");}


    //installa service worker
    if ('serviceWorker' in navigator) 
    {
        window.addEventListener('load', function() 
        {
            navigator.serviceWorker.register('../serviceWorker.js').then(function(registration) 
            {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) 
            {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }

    var moving = false;
    var fpsClient;
    var fpsServer;
    var nearPlayer = 0;
    var nearChest = 0;
    var charge = 0;
    var keys = [];
    keys[32] = false;
    var touch = false;



    //LOGIN
    DOM.login_button.onclick = function()
    {
        if(DOM.Qlow.checked){SETTINGS.quality = 0;}
        if(DOM.Qmed.checked){SETTINGS.quality = 1;}
        if(DOM.Qhig.checked){SETTINGS.quality = 3;}
        if(DOM.Qins.checked){SETTINGS.quality = 50;}


        //SE MOBILE FULLSCREEN E JOYSTICK
        if(SETTINGS.onMobile)
        {
            SETTINGS.openFullscreen();     
            
            joystick = new VirtualJoystick(
                        {
                        mouseSupport: true,
                        stationaryBase: true,
                        baseX: 90,
                        baseY: 260,
                        limitStickTravel: true,
                        stickRadius: 50
                        });
        }

        //RISCALA IL CANVAS
        setTimeout(function () 
        {
            SETTINGS.setScaleFactor()
            SETTINGS.canvasResize()
        }, 1000);

        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("login", {name:login_username.value});

        DOM.page_login.style.display = "none";
        DOM.page_game.style.display = "contents";

        setInterval(clientUpdate ,1000/30); 
    }






    
    document.onkeydown = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=true;
        
        if(event.keyCode == 68 || event.keyCode == 39) //d 
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}
    }
    
    document.onkeyup = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=false;

        if(event.keyCode == 68 || event.keyCode == 39) //d
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { 
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                socket.emit("shoot");
                charge = 0
            }
        }
    }    
    


    function touchStart(ev) 
    {
        touch = true
    };

    
    function touchEnd(ev) 
    {
            touch = false
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                socket.emit("shoot");
                charge = 0
            }
    };


    DOM.canvas.addEventListener('touchstart', touchStart, false);
    DOM.canvas.addEventListener('touchend', touchEnd, false);


    
    for(let i=-2; i<(room.width/200)+2; i++)
    {
        GAME.Fog(i*200,-180)
        GAME.Fog(i*200,room.height+180)
    }

    for(let i=-2; i<(room.height/200)+2; i++)
    {
        GAME.Fog(-200,i*200)
        GAME.Fog(room.width+200,i*200)
    }

    var lastLoop;
    var lastScaleX;
    var lastScaleY;
    update = function()
    {
        if(lastScaleX !=window.innerWidth || lastScaleY != window.innerHeight)
        {
            lastScaleX = window.innerWidth
            lastScaleY = window.innerHeight

            SETTINGS.setScaleFactor()
            SETTINGS.canvasResize()
        }


        if(keys[32] || touch == true) //space
        { if(charge < 10) {charge += 0.5}}


            //aggiorna fps
            let thisLoop = new Date();
            if(Math.random() > 0.8)
            {fpsClient = Math.floor(1000 / (thisLoop - lastLoop));}
            lastLoop = thisLoop;

            let me = GAME.Players.list[id];
            let minDist = 99999999;
            let final = null;

           
            for(let i in  GAME.Players.list)
            {
                let current =  GAME.Players.list[i];

                GAME.Scia(current.x*SETTINGS.globalScaleX,  current.y*SETTINGS.globalScaleY);
        
                if(current.id == id)
                {
                    for(let i=0; i<SETTINGS.quality; i++)
                    {GAME.Onda(Math.random()*room.width*SETTINGS.globalScaleX, Math.random()*room.height*SETTINGS.globalScaleY);} 

                    camera.update(current.x*SETTINGS.globalScaleX, current.y*SETTINGS.globalScaleY);
                }
                else
                {    
                    let dist = ENGINE.point_distance(me.x,me.y,current.x,current.y)
                    if(dist < minDist)
                    {
                        final = current
                        minDist = dist
                    }
                }
            }

            //trova il giocatore piu vicino
            if(final != null)
            {nearPlayer = ENGINE.point_direction(me.x,me.y,final.x,final.y) ;}
            else
            {nearPlayer = 0}
 
            final = null;
            minDist = 999999999;


            //trova la cassa piu vicina
            for(let i in  GAME.Chest.list)
            {
                let current =  GAME.Chest.list[i];
                let dist = ENGINE.point_distance(me.x,me.y,current.x,current.y)
                if(dist < minDist)
                {
                    final = current
                    minDist = dist
                }
            }
            
            if(final != null)
            {nearChest = ENGINE.point_direction(me.x,me.y,final.x,final.y) ;}
            else
            {nearChest = 0}


            //joystick
            if(SETTINGS.onMobile == true && joystick != null)
            {
                if( joystick.right() )
                { socket.emit("keyPress", {id:"right", state:true}); } else { socket.emit("keyPress", {id:"right", state:false}); }
                if( joystick.left() )
                {  socket.emit("keyPress", {id:"left", state:true});} else {  socket.emit("keyPress", {id:"left", state:false});}
                if( joystick.up() )
                {  socket.emit("keyPress", {id:"up", state:true}); } else {  socket.emit("keyPress", {id:"up", state:false}); }
                if( joystick.down() )
                {  socket.emit("keyPress", {id:"down", state:true}); } else {  socket.emit("keyPress", {id:"down", state:false}); }
            }

    }

    var sBussola = GAME.sprite(LOADER.sprBussola,1,64,64,1)
    var sFreccia = GAME.sprite(LOADER.sprFreccia,1,64,64,1)

    draw = function()
    {   
            //pulisci il canvas
            DOM.ctx.clearRect(0, 0, canvas.width, canvas.height);

            //disegna la mappa
            //room.map.draw(ctx, camera.xView, camera.yView);
            DOM.ctx.fillStyle = "#32479C";
            DOM.ctx.fillRect(0,0,canvas.width,canvas.height);
            DOM.ctx.fillStyle = "#000000";


            //aggiorna e disegna le scie
            for(let i = GAME.Onda.list.length-1 ; i >= 0; i--)
            {       
                let current =  GAME.Onda.list[i];
                current.update();
                current.draw();
            }

            //aggiorna e disegna le onde
            for(let i = GAME.Scia.list.length-1 ; i >= 0; i--)
            {       
                let current =  GAME.Scia.list[i];
                current.update();
                current.draw();
            }

            //disegna le casse
            for(let i in  GAME.Chest.list)
            {
                let current =  GAME.Chest.list[i];
                current.draw();
            }

            //disegna tutti i giocatori
            for(let i in  GAME.Players.list)
            {
                let current =  GAME.Players.list[i];
                current.draw();
            }
            
            
            //disegna palle di cannone
            for(let i in  GAME.Balls.list)
            {
                let current =  GAME.Balls.list[i];
                current.draw();
            }

            //disegna esplosioni
            for(let i in  GAME.Explosion.list)
            {
                let current =  GAME.Explosion.list[i];
                current.update();
                current.draw();
            }

            //disegna splash
            for(let i in  GAME.Splash.list)
            {
                let current =  GAME.Splash.list[i];
                current.update();
                current.draw();
            }


            //disegna splash
            for(let i in  GAME.Fog.list)
            {
                let current =  GAME.Fog.list[i];
                current.draw();
            }


            //disegna barra caricamento
            if(charge > 0)
            {
                let X = GAME.Players.list[id].x*SETTINGS.globalScaleX-camera.xView;
                let Y = GAME.Players.list[id].y*SETTINGS.globalScaleY-camera.yView;

                DOM.ctx.fillStyle = "black";
                DOM.ctx.fillRect(X-25*SETTINGS.globalScaleY, Y+30*SETTINGS.globalScaleY, 50*SETTINGS.globalScaleY, 5);    
                DOM.ctx.fillStyle = "red";
                DOM.ctx.fillRect(X-25*SETTINGS.globalScaleY, Y+30*SETTINGS.globalScaleY, charge*5*SETTINGS.globalScaleY, 5);
            }

            //disegna fps
            DOM.ctx.fillStyle = "black";
            DOM.ctx.font = (8*SETTINGS.globalScaleX)+"px Georgia";
            DOM.ctx.fillText("FPS C:"+fpsClient, 10,  (480-64)*SETTINGS.globalScaleY);
            DOM.ctx.fillText("FPS S:"+fpsServer, 10,  (480-32)*SETTINGS.globalScaleY);

            //disegna punti
            DOM.ctx.fillText("POINTS:"+GAME.Players.list[socket.id].points, 10, 16*SETTINGS.globalScaleY);

            //disegna bussola 
            GAME.drawSprite(sBussola, 0, (640-32)*SETTINGS.globalScaleX,  32*SETTINGS.globalScaleY, 0, 1);
            GAME.drawSprite(sFreccia, 0, (640-32)*SETTINGS.globalScaleX,  32*SETTINGS.globalScaleY, nearChest, 0.8);

            if(Object.keys(GAME.Players.list).length > 1)
            {GAME.drawSprite(sFreccia, 1, (640-32)*SETTINGS.globalScaleX,  32*SETTINGS.globalScaleY, nearPlayer, 0.8);}

    }



    clientUpdate = function()
    {
        update();
        draw();
    }



    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });

    
    socket.on('hit',function(data)
    {   
        let range = 5*data.num
        for(let i=0; i<data.num; i++)
        {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
    });


    socket.on('playerDie',function(data)
    {   
        let range = 30
        for(let i=0; i<20; i++)
        {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
    });


    socket.on('ballEnd',function(data)
    {   
        GAME.Splash(Math.random(),GAME.Balls.list[data].x,GAME.Balls.list[data].y)
        delete GAME.Balls.list[data]    
    });

    socket.on('disconnection',function(data)
    {  
        delete GAME.Players.list[data];
    });


    socket.on('newPositions',function(data)
    {
           fpsServer = data.fps;
            //aggiorna posizione giocatori
            for(let i = 0 ; i < data.players.length; i++)
            {
                let current = data.players[i];

                if(GAME.Players.list[current.id] == undefined)
                {          
                    GAME.Players(current.id, current.x, current.y, current.name, current.angle);
                }
                else
                {            
                    GAME.Players.list[current.id].x = current.x;
                    GAME.Players.list[current.id].y = current.y;
                    GAME.Players.list[current.id].angle = current.angle;
                    GAME.Players.list[current.id].life = current.life;
                    GAME.Players.list[current.id].points = current.points;
                }
            }


            //aggiorna posizione palle 
            for(let i = 0 ; i < data.balls.length; i++)
            {
                let current = data.balls[i];

                if(GAME.Balls.list[current.id] == undefined)
                {          
                    GAME.Balls(current.id,current.x, current.y);
                }
                else
                {            
                    GAME.Balls.list[current.id].x = current.x;
                    GAME.Balls.list[current.id].y = current.y;
                }
            }


            //aggiorna posizione casse 
            for(let i = 0 ; i < data.chests.length; i++)
            {
                let current = data.chests[i];

                if(GAME.Chest.list[current.id] == undefined)
                {          
                    GAME.Chest(current.id,current.x, current.y);
                }
                else
                {            
                    GAME.Chest.list[current.id].x = current.x;
                    GAME.Chest.list[current.id].y = current.y;
                }
            }


    });

</script>


</body>


</html>