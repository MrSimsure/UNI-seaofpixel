
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">
<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>


<body  id="container" style ="margin:0; overflow-x:hidden; overflow-y:hidden;">

<div id="page_login"  >

        Username: <input id="login_username" type="text"></input>
        <button id="login_button">Logga</button>

        <div><input type="checkbox" id="Qlow" name="qualiy low">    Low Quality             </div>
        <div><input type="checkbox" id="Qmed" name="qualiy medium"> Medium Quality          </div>
        <div><input type="checkbox" id="Qhig" name="qualiy high">   High Quality            </div>
        <div><input type="checkbox" id="Qins" name="qualiy insane"> Destroy my PC Quality   </div>

</div>


 <div id="page_game"  style="display:none; position:relative;  z-index:0">

    <canvas id="canvas" style="  z-index: 1; position:absolute;" width="480" height="270""></canvas>
    <!--<canvas id="canvasShader" style="z-index: 0; position:absolute;"  data-fragment-url="client/cells.frag" width="480" height="270"></canvas>-->

</div>


<script src="/client/js/engine.js"></script>

<script type="text/javascript" src="https://rawgit.com/patriciogonzalezvivo/glslCanvas/master/dist/GlslCanvas.js"></script>
<script src="/client/js/virtualjoystick.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="/client/js/setting.js"></script>
<script src="/client/js/game.js"></script>
<script src="/client/js/load.js"></script>


<script>

if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('client/pwabuilder-sw.js').then(function(registration) {
        // Registration was successful
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
        // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}

    var moving = false;
    var fpsClient;
    var fpsServer;
    //var shad = new GlslCanvas(canvasShader);

    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });



    //LOGIN
    login_button.onclick = function()
    {
        if(Qlow.checked){SETTINGS.quality = 0;}
        if(Qmed.checked){SETTINGS.quality = 2;}
        if(Qhig.checked){SETTINGS.quality = 6;}
        if(Qins.checked){SETTINGS.quality = 50;}


        //SE MOBILE FULLSCREEN E JOYSTICK
        if(SETTINGS.onMobile)
        {
            SETTINGS.openFullscreen();     
            
            joystick = new VirtualJoystick(
                        {
                        mouseSupport: true,
                        stationaryBase: true,
                        baseX: 90,
                        baseY: 260,
                        limitStickTravel: true,
                        stickRadius: 50
                        });
        }

        //RISCALA IL CANVAS
        setTimeout(function () 
        {
            SETTINGS.setScaleFactor()
            SETTINGS.canvasResize()
        }, 1000);

        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("login", {name:login_username.value});

        page_login.style.display = "none";
        page_game.style.display = "inline-block";
    }

    
    document.onkeydown = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:true}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}
        if(event.keyCode == 32) //space
        { socket.emit("shoot", {id:"space", state:true});}
    }
    
    document.onkeyup = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:false}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { socket.emit("shoot", {id:"space", state:false});}
    }    
    


    function touchStart(ev) 
    {
        { socket.emit("shoot", {id:"space", state:true});}
    };

    
    function touchEnd(ev) 
    {
        { socket.emit("shoot", {id:"space", state:false});}
    };


    canvas.addEventListener('touchstart', touchStart, false);
    canvas.addEventListener('touchend', touchEnd, false);





    var lastLoop;
    update = function()
    {
            //aggiorna fps
            let thisLoop = new Date();
            if(Math.random() > 0.8)
            {fpsClient = Math.floor(1000 / (thisLoop - lastLoop));}
            lastLoop = thisLoop;


            //trova il giocatore appartenente a questo client
            for(let i in  GAME.Players.list)
            {
                let current =  GAME.Players.list[i];

                GAME.Scia(current.x*SETTINGS.globalScaleX,  current.y*SETTINGS.globalScaleY);
        
                if(current.id == id)
                {
                    //GAME.Onda( (current.x*SETTINGS.globalScaleX)+ENGINE.random_range(-2000,2000) , (current.y*SETTINGS.globalScaleY)+ENGINE.random_range(-2000,2000));
                    for(let i=0; i<SETTINGS.quality; i++)
                    {
                        //GAME.Explosion(Math.random()*room.width*SETTINGS.globalScaleX, Math.random()*room.height*SETTINGS.globalScaleY);
                        GAME.Onda(Math.random()*room.width*SETTINGS.globalScaleX, Math.random()*room.height*SETTINGS.globalScaleY);
                    } 

                    camera.update(current.x*SETTINGS.globalScaleX, current.y*SETTINGS.globalScaleY);
                    //shad.setUniform("camera_x",camera.xView); 
                    //shad.setUniform("camera_y",camera.yView); 
                }
            }


            if(SETTINGS.onMobile == true && joystick != null)
            {
                if( joystick.right() )
                { socket.emit("keyPress", {id:"right", state:true}); } else { socket.emit("keyPress", {id:"right", state:false}); }
                if( joystick.left() )
                {  socket.emit("keyPress", {id:"left", state:true});} else {  socket.emit("keyPress", {id:"left", state:false});}
                if( joystick.up() )
                {  socket.emit("keyPress", {id:"up", state:true}); } else {  socket.emit("keyPress", {id:"up", state:false}); }
                if( joystick.down() )
                {  socket.emit("keyPress", {id:"down", state:true}); } else {  socket.emit("keyPress", {id:"down", state:false}); }
            }



    }


    draw = function()
    {
            //pulisci il canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            //disegna la mappa
            //room.map.draw(ctx, camera.xView, camera.yView);
            ctx.fillStyle = "#32479C";
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "#000000";


            //aggiorna e disegna le scie
            for(let i = GAME.Onda.list.length-1 ; i >= 0; i--)
            {       
                let current =  GAME.Onda.list[i];
                current.update();
                current.draw();
            }

            //aggiorna e disegna le onde
            for(let i = GAME.Scia.list.length-1 ; i >= 0; i--)
            {       
                let current =  GAME.Scia.list[i];
                current.update();
                current.draw();
            }

            //disegna tutti i giocatori
            for(let i in  GAME.Players.list)
            {
                let current =  GAME.Players.list[i];
                current.draw();
            }
            
            //disegna palle di cannone
            for(let i in  GAME.Balls.list)
            {
                let current =  GAME.Balls.list[i];
                current.draw();
            }

            //disegna palle di cannone
            for(let i in  GAME.Explosion.list)
            {
                let current =  GAME.Explosion.list[i];
                current.update();
                current.draw();
            }

            //disegna palle di cannone
            for(let i in  GAME.Splash.list)
            {
                let current =  GAME.Splash.list[i];
                current.update();
                current.draw();
            }

            //disegna fps
            ctx.font = (8*SETTINGS.globalScaleX)+"px Georgia";
            ctx.fillText("FPS C:"+fpsClient, 10,  35);
            ctx.fillText("FPS S:"+fpsServer, 10,  75);
    }



    clientUpdate = function()
    {
        update();
        draw();
    }


    setInterval(clientUpdate ,1000/30); 
    
    socket.on('hit',function(data)
    {   
        let range = 20
        for(let i=0; i<8; i++)
        {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
    });

    socket.on('ballEnd',function(data)
    {   
        GAME.Splash(Math.random(),GAME.Balls.list[data].x,GAME.Balls.list[data].y)
        delete GAME.Balls.list[data]    
    });

    socket.on('disconnection',function(data)
    {  
        delete GAME.Players.list[data];
    });


    socket.on('newPositions',function(data)
    {
           fpsServer = data.fps;
            //aggiorna posizione giocatori
            for(let i = 0 ; i < data.players.length; i++)
            {
                let current = data.players[i];

                if(GAME.Players.list[current.id] == undefined)
                {          
                    GAME.Players(current.id, current.x, current.y, current.name, current.angle);
                }
                else
                {            
                    GAME.Players.list[current.id].x = current.x;
                    GAME.Players.list[current.id].y = current.y;
                    GAME.Players.list[current.id].angle = current.angle;
                }
            }


            //aggiorna posizione palle 
            for(let i = 0 ; i < data.balls.length; i++)
            {
                let current = data.balls[i];

                if(GAME.Balls.list[current.id] == undefined)
                {          
                    GAME.Balls(current.id,current.x, current.y);
                }
                else
                {            
                    GAME.Balls.list[current.id].x = current.x;
                    GAME.Balls.list[current.id].y = current.y;
                }
            }
    });

</script>


</body>