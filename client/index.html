
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">

<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>

<div id="page_login">
    Username: <input id="login_username" type="text"></input>
    <button id="login_button">Logga</button>
</div>
 <div id="page_game" style="display:none; position:absolute;  z-index:0">
    <canvas id="canvas" width="480" height="270" style="border:1px solid #000000;"></canvas>
</div>

<script src="/client/js/engine.js"></script>
<script src="/client/js/virtualjoystick.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/client/js/load.js"></script>
<script src="/client/js/game.js"></script>
<script src="/client/js/init.js"></script>
<script src="/client/js/clientEntity.js"></script>


<script>

    var moving = false;

    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });


    //LOGIN
    login_button.onclick = function()
    {
        //SE MOBILE FULLSCREEN E JOYSTICK
        if(SETTINGS.onMobile)
        {
            openFullscreen();     
            
            joystick = new VirtualJoystick(
                        {
                        mouseSupport: true,
                        stationaryBase: true,
                        baseX: 100,
                        baseY: 260,
                        limitStickTravel: true,
                        stickRadius: 50
                        });
        }

        //RISCALA IL CANVAS
        setTimeout(function () 
        {
            setScaleFactor()
            canvasResize()
        }, 200);

        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("login", {name:login_username.value});

        page_login.style.display = "none";
        page_game.style.display = "inline-block";
    }

    
    document.onkeydown = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:true}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}
        if(event.keyCode == 32) //space
        { socket.emit("shoot", {id:"space", state:true});}
    }
    
    document.onkeyup = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:false}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { socket.emit("shoot", {id:"space", state:false});}
    }    
    

    function touchStart(ev) 
    {
        { socket.emit("shoot", {id:"space", state:true});}
    };

    
    function touchEnd(ev) 
    {
        { socket.emit("shoot", {id:"space", state:false});}
    };


    canvas.addEventListener('touchstart', touchStart, false);
    canvas.addEventListener('touchend', touchEnd, false);





    update = function()
    {

        //trova il giocatore appartenente a questo client
        for(var i in Players.list)
        {
            var current = Players.list[i];

            Scia(current.x*SETTINGS.globalScaleX,  current.y*SETTINGS.globalScaleY);
    
            if(current.id == id)
            {camera.update(current.x*SETTINGS.globalScaleX, current.y*SETTINGS.globalScaleY);}
        }


        if(SETTINGS.onMobile == true && joystick != null)
        {
            if( joystick.right() )
            { socket.emit("keyPress", {id:"right", state:true}); } else { socket.emit("keyPress", {id:"right", state:false}); }
            if( joystick.left() )
            {  socket.emit("keyPress", {id:"left", state:true});} else {  socket.emit("keyPress", {id:"left", state:false});}
            if( joystick.up() )
            {  socket.emit("keyPress", {id:"up", state:true}); } else {  socket.emit("keyPress", {id:"up", state:false}); }
            if( joystick.down() )
            {  socket.emit("keyPress", {id:"down", state:true}); } else {  socket.emit("keyPress", {id:"down", state:false}); }
        }


        //crea le onde
        if(Math.random() < 1.0)
        {
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
            Onda(Math.random()*room.width*SETTINGS.globalScaleX,  Math.random()*room.height*SETTINGS.globalScaleY);
        }
    }


    draw = function()
    {

        //pulisci il canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        //disegna la mappa
        room.map.draw(ctx, camera.xView, camera.yView);

        //aggiorna scie
        for(var i=Onda.list.length-1 ; i >= 0; i--)
        {       
            var current = Onda.list[i];
            current.update();
            current.draw();
        }

        //aggiorna onde
        for(var i=Scia.list.length-1 ; i >= 0; i--)
        {       
            var current = Scia.list[i];
            current.update();
            current.draw();
        }


        
        //disegna tutti i giocatori
        for(var i in Players.list)
        {
            var current = Players.list[i];

            var playerX = current.x*SETTINGS.globalScaleX-camera.xView;
            var playerY = current.y*SETTINGS.globalScaleY-camera.yView;
 

            for(var n=0; n<23 ; n++)
            {
                drawFrame(stripBoat, n, playerX,  playerY-SETTINGS.globalScaleY*n, current.angle);
            }

            ctx.font = (30*SETTINGS.globalScaleX)+"px Georgia";
            ctx.fillText(current.name, playerX-(current.name.length*8),  playerY-128);
        }


        //disegna tutti i giocatori
        for(var i in Balls.list)
        {
            var current = Balls.list[i];

            var ballX = current.x*SETTINGS.globalScaleX-camera.xView;
            var ballY = current.y*SETTINGS.globalScaleY-camera.yView;
 
            drawSprite(sprBall, ballX,  ballY, 0, 0.4);           
        }
    }



    clientUpdate = function()
    {
        update();
        draw();
    }

    //sprScia.onload = function()
    {setInterval(clientUpdate ,1000/30); }
    

    socket.on('ballEnd',function(data)
    {
        delete Balls.list[data];
    });

    socket.on('disconnection',function(data)
    {
        delete Players.list[data];
    });
    
    socket.on('newPositions',function(data)
    {
            //disegna tutti i giocatori
            for(var i = 0 ; i < data.players.length; i++)
            {
                var current = data.players[i];

                if(Players.list[current.id] == undefined)
                {          
                    Players(current.id, current.x, current.y, current.name, current.angle);
                }
                else
                {            
                    Players.list[current.id].x = current.x;
                    Players.list[current.id].y = current.y;
                    Players.list[current.id].angle = current.angle;
                }
            }


            //disegna tutti i giocatori
            for(var i = 0 ; i < data.balls.length; i++)
            {
                var current = data.balls[i];

                if(Balls.list[current.id] == undefined)
                {          
                    Balls(current.id,current.x, current.y);
                }
                else
                {            
                    Balls.list[current.id].x = current.x;
                    Balls.list[current.id].y = current.y;
                }
            }
    });

</script>