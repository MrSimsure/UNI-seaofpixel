<!DOCTYPE html>
<html lang="en">
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="theme-color" content="#4586ef"/>
<meta name="Description" content="A small JS and HTML5 game about pirates!">

<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>

<head>
    <link id="css" rel="stylesheet" type="text/css">
    
    <script src="/client/js/init.js"></script>
    <script src="/client/js/engine.js"></script>
    
    <script src="/client/js/virtualjoystick.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <script src="/client/js/setting.js"></script>
    <script src="/client/js/game.js"></script>
</head>

<body  id="container" style ="margin:0; overflow-x:hidden; overflow-y:hidden;">
 
<title>Sea of Pixel</title>

<!--PAGINA INIZIALE-->
<div id="page_init"  style="display:inline; position: absolute;   width: 100%; height: 100%;  z-index:2">
    <label class="title" style="width: 100%; top:10%; font-weight:700;">Vuoi abilitare la musica?</label>
    
    <div style="display: inline-block;  width: 49%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_on" style=" top:50%;  width:30%;  height:30%;  margin:0 auto;    font-weight:600;">SI</button>
    </div>

    <div style="display: inline-block;  width: 50%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_off" style="top:50%;  width:30%;  height:30%;    font-weight:600;">NO</button>
    </div>
</div>

<!--PAGINA MENU PRINCIPALE-->
<div id="page_menu"  style="display:none; position: absolute;   width: 100%; height: 100%;  z-index:2;  align-items: center; justify-content: center;">
    
    <label class="title"style="width: 100%; top:5%;  font-weight:700;">SEA OF PIXEL</label>
    <label id ="splash" class="title" style="font-size: 2.0vw; width: 100%; top:13%; font-weight:300;">frase</label>

    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
                
        <label class="inLabel" for="login_username"   style="top:50%; width:50%;">Username</label>
        <input class="inInput" id="login_username"    style="top:50%; width:50%;" type="text"></input>

        <label class="inLabel" for="login_password"   style="top:55%; width:50%;">Password</label>
        <input class="inInput" id="login_password"    style="top:55%;  width:50%;" type="text"></input>

    </div>

    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
        
        <button class="colButton" id="register_button" style=" top:51%;  width:80%;  height:10%;  font-weight:600;">REGISTRATI</button>
        <button class="colButton" id="login_button" style=" top:51%;  width:80%;  height:10%;   font-weight:600;">ENTRA</button>
    </div>

    <div style="width: 50%; height: 100%;   margin:0 auto;  align-items: center; justify-content: center;">
        
        <button class="colButton" id="music_button_off" style="visibility:hidden; display:relative; display: block; top:50%;  width:30%;  height:30%;   font-size:15px;   font-weight:600;">test</button>
    </div>
</div>

<!--PAGINA OPZIONI-->
<div id="page_login"   style="display:none; position:absolute;  z-index:2">
        <div><input type="checkbox" id="Qlow" name="qualiy low">      <label for="Qlow">Low Quality</label>           </div>
        <div><input type="checkbox" id="Qmed" name="qualiy medium">     <label for="Qmed">Medium Quality</label>      </div>
        <div><input type="checkbox" id="Qhig" name="qualiy high">         <label for="Qhig">High Quality</label>      </div>
        <div><input type="checkbox" id="Qins" name="qualiy insane">  <label for="Qins">Destroy my PC Quality</label>  </div>
</div>

<!--PAGINA DI GIOCO-->
 <div id="page_game"  style="display:inline; position:relative;  z-index:0">
    <canvas id="canvas" style="  z-index: 1; position:absolute;" width="640" height="480"></canvas>
</div>

<script src="/client/js/load.js"></script>
<script src="/client/js/loop.js"></script>

<script>

    var mainDir = window.location.href
    var moving = false;
    var fpsClient;
    var fpsServer;
    var nearPlayer = 0;
    var nearChest = 0;
    var charge = 0;
    var keys = [];
    keys[32] = false;
    var touch = false;
    var inGame = false;
    var lastTuch = 0;
    
    initMenu()

    //LOGIN
    DOM.login_button.onclick = function()
    {   
        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("login", {name:login_username.value,    password:login_password.value});
    }

    //REGISTRAZIONE
    DOM.register_button.onclick = function()
    {   
        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("register", {name:login_username.value,    password:login_password.value});
    }

    document.onkeydown = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=true;
        
        if(event.keyCode == 16)
        {AUDIO = !AUDIO}

        if(event.keyCode == 68 || event.keyCode == 39) //d 
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}
    }
    
    document.onkeyup = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=false;

        if(event.keyCode == 68 || event.keyCode == 39) //d
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { 
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                
                socket.emit("shoot");
                charge = 0
            }
        }
    }    

    function touchStart(ev) 
    {
        touch = true
        console.log(Date.now() - lastTuch)
        if( (Date.now() - lastTuch) < 200)
        {SETTINGS.openFullscreen();}

        lastTuch = Date.now();
    };
    
    function touchEnd(ev) 
    {
            touch = false
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                socket.emit("shoot");
                charge = 0
            }
    };

    DOM.canvas.addEventListener('touchstart', touchStart, {passive: true}, false);
    DOM.canvas.addEventListener('touchend', touchEnd, {passive: true}, false);

    DOM.login_username.onclick = function(){DOM.login_username.style = "top:50%; width:50%;";}
    DOM.login_password.onclick = function(){DOM.login_password.style = "top:55%; width:50%;";}
    
    //CONNESSIONE
    socket.on('acces',function(data)
    {    
        if(data == true)
        {
            socket.emit("gameStart",login_username.value)
            initGame();

            socket.on('hit',function(data)
            {   
                let range = 5*data.num
                for(let i=0; i<data.num; i++)
                {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}

                let me = GAME.Players.list[id]; 
                let volume = ENGINE.clamp(Math.abs( 1-( ENGINE.clamp(ENGINE.point_distance(me.x,me.y,data.x,data.y),0,1000))/1000 ),0,1);
                GAME.playAudio(LOADER.souHit,volume);
            });

            socket.on('playerDie',function(data)
            {   
                let range = 30
                for(let i=0; i<20; i++)
                {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
            });

            socket.on('ballEnd',function(data)
            {   
                GAME.Splash(Math.random(),GAME.Balls.list[data].x,GAME.Balls.list[data].y)
                delete GAME.Balls.list[data]    
            });
            socket.on('disconnection',function(data)
            {  
                delete GAME.Players.list[data];
            });
            socket.on('newPositions',function(data)
            {
                fpsServer = data.fps;
                let lastOwner = -1;
                //aggiorna posizione palle 
                    for(let i = 0 ; i < data.balls.length; i++)
                    {
                        let current = data.balls[i];

                        if(GAME.Balls.list[current.id] == undefined)
                        {          
                            GAME.Balls(current.id,current.x, current.y);

                            if(SETTINGS.audio == true && lastOwner != current.owner)
                            {
                                let me = GAME.Players.list[id]; 
                                let volume = ENGINE.clamp(Math.abs( 1-( ENGINE.clamp(ENGINE.point_distance(me.x,me.y,current.x,current.y),0,1000))/1000 ),0,1);
                                GAME.playAudio(LOADER.souCannon,volume);                 
                            }
                            lastOwner = current.owner;
                        }
                        else
                        {            
                            GAME.Balls.list[current.id].x = current.x;
                            GAME.Balls.list[current.id].y = current.y;
                        }
                    }

                    //aggiorna posizione giocatori
                    for(let i = 0 ; i < data.players.length; i++)
                    {
                        let current = data.players[i];

                        if(GAME.Players.list[current.id] == undefined)
                        {          
                            GAME.Players(current.id, current.x, current.y, current.name, current.angle);
                        }
                        else
                        {            
                            GAME.Players.list[current.id].x = current.x;
                            GAME.Players.list[current.id].y = current.y;
                            GAME.Players.list[current.id].angle = current.angle;
                            GAME.Players.list[current.id].life = current.life;
                            GAME.Players.list[current.id].points = current.points;
                        }
                    }

                    //aggiorna posizione casse 
                    for(let i = 0 ; i < data.chests.length; i++)
                    {
                        let current = data.chests[i];

                        if(GAME.Chest.list[current.id] == undefined)
                        {          
                            GAME.Chest(current.id,current.x, current.y);
                        }
                        else
                        {            
                            GAME.Chest.list[current.id].x = current.x;
                            GAME.Chest.list[current.id].y = current.y;
                        }
                    }
            });
        }
        else
        {
            DOM.login_username.style = " position:relative; display:block;top:50%; width:50%; border:solid; border-width:2px;  border-color:red;";
            DOM.login_password.style = " position:relative; display:block;top:55%; width:50%; border:solid; border-width:2px;  border-color:red;";
        }
    });

    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });

    //fai diventare irreversibilmente il giocatore un bot cheater in grado di muoversi casualente e spararre cannonate infinite
    iAmBot = function()
    {
        mov = function() 
        {
            arr = ["left", "right"];
            i = Math.round(Math.random());
            socket.emit("keyPress", {id: arr[(i+1)%2], state: false});
            socket.emit("keyPress", {id: arr[i], state: true});
        }
        setInterval(mov, 200)
        avanti = () => socket.emit("keyPress", {id:"up", state:(Math.random() >= 0.5)});
        setInterval(avanti, 300)
        spara = () => socket.emit("shoot");
        setInterval(spara,100);
        return "Complimenti, ora sei un bot senza anima ne morale portatore di morte e distruzione"
    }
    
</script>

</body>

</html>