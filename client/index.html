
<!DOCTYPE html>
<html lang="en">
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="theme-color" content="#4586ef"/>
<meta name="Description" content="A small JS and HTML5 game about pirates!">



<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>

<head>
    <link rel="stylesheet" type="text/css" href="client/index.css">
</head>


<body  id="container" style ="margin:0; overflow-x:hidden; overflow-y:hidden;">
    
<title>Sea of Pixel</title>

<div id="page_init"  style="display:inline; position: absolute;   width: 100%; height: 100%;  z-index:2">
    <label style="display:inline; position: fixed; width: 100%; top:10%; text-align: center; font-size:44px;font-weight:700;">Vuoi abilitare la musica?</label>
    
    <div style="display: inline-block;  width: 49%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_on" style="position:relative; display: block;  top:50%;  width:30%;  height:30%;  margin:0 auto;  font-size:65px;  font-weight:600;">SI</button>
    </div>

    <div style="display: inline-block;  width: 50%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_off" style="position:relative; display: block;  top:50%;  width:30%;  height:30%;   font-size:65px;   font-weight:600;">NO</button>
    </div>
</div>


<div id="page_menu"  style="display:none; position: absolute;   width: 100%; height: 100%;  z-index:2;    align-items: center;justify-content: center;">
    <label style="display:inline; position: fixed; width: 100%; top:5%; text-align: center; font-size:44px;font-weight:700;">SEAS OF PIXEL</label>
    
    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
        
                
        <label class="inLabel" for="login_username"   style="left:15%; top:50%">Username :</label>
        <input class="inInput" id="login_username"    style="left:15%; top:50%; width:50%;" type="text"></input>

        <label class="inLabel" for="login_password"   style="left:15%; top:55%">Password :</label>
        <input class="inInput" id="login_password"    style="left:15%; top:55%;  width:50%;" type="text"></input>

    </div>


    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
        
        <button class="colButton" id="register_button" style="position:relative; display: block;  top:40%;  width:80%;  height:20%;   font-size:25px;   font-weight:600;">REGISTRATI</button>
        <button class="colButton" id="login_button" style="position:relative; display: block; top:40%;  width:80%;  height:20%;   font-size:25px;   font-weight:600;">ENTRA</button>
    </div>


    <div style="width: 50%; height: 100%;   margin:0 auto;  align-items: center; justify-content: center;">
        
        <button class="colButton" id="music_button_off" style="position:relative; display: block; top:50%;  width:30%;  height:30%;   font-size:15px;   font-weight:600;">test</button>
    </div>
</div>



<div id="page_login"   style="display:none; position:absolute;  z-index:2">
        <div><input type="checkbox" id="Qlow" name="qualiy low">      <label for="Qlow">Low Quality</label>           </div>
        <div><input type="checkbox" id="Qmed" name="qualiy medium">     <label for="Qmed">Medium Quality</label>      </div>
        <div><input type="checkbox" id="Qhig" name="qualiy high">         <label for="Qhig">High Quality</label>      </div>
        <div><input type="checkbox" id="Qins" name="qualiy insane">  <label for="Qins">Destroy my PC Quality</label>  </div>

</div>


 <div id="page_game"  style="display:inline; position:relative;  z-index:0">
    <canvas id="canvas" style="  z-index: 1; position:absolute;" width="640" height="480"></canvas>
</div>

<script src="/client/js/init.js"></script>
<script src="/client/js/engine.js"></script>

<script src="/client/js/virtualjoystick.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="/client/js/setting.js"></script>
<script src="/client/js/game.js"></script>
<script src="/client/js/load.js"></script>
<script src="/client/js/loop.js"></script>

<script>

   

    var moving = false;
    var fpsClient;
    var fpsServer;
    var nearPlayer = 0;
    var nearChest = 0;
    var charge = 0;
    var keys = [];
    keys[32] = false;
    var touch = false;
    var inGame = false;




    var menu_update = setInterval(menuDraw ,1000/90); 

    //LOGIN
    DOM.login_button.onclick = function()
    {   


        clearInterval(menu_update)
        
        if(DOM.Qlow.checked){SETTINGS.quality = 0;}
        if(DOM.Qmed.checked){SETTINGS.quality = 1;}
        if(DOM.Qhig.checked){SETTINGS.quality = 3;}
        if(DOM.Qins.checked){SETTINGS.quality = 50;}


        //SE MOBILE FULLSCREEN E JOYSTICK
        if(SETTINGS.onMobile)
        {
            SETTINGS.openFullscreen();     
            
            joystick = new VirtualJoystick(
                        {
                        mouseSupport: true,
                        stationaryBase: true,
                        baseX: 90,
                        baseY: 260,
                        limitStickTravel: true,
                        stickRadius: 50
                        });
        }


console.log(login_username.value)
        //INVIA I DATI DI LOGIN E PASSA AL GIOCO
        socket.emit("login", {name:login_username.value});

        DOM.page_menu.style.display = "none";
        DOM.page_login.style.display = "none";
        DOM.page_game.style.display = "inline";


        initGame();

        inGame = true;
        
    }




    
    document.onkeydown = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=true;
        
        if(event.keyCode == 16)
        {AUDIO = !AUDIO}

        if(event.keyCode == 68 || event.keyCode == 39) //d 
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}
    }
    

    document.onkeyup = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=false;

        if(event.keyCode == 68 || event.keyCode == 39) //d
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { 
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                
                socket.emit("shoot");
                charge = 0
            }
        }
    }    
    




    function touchStart(ev) 
    {
        touch = true
    };

    
    function touchEnd(ev) 
    {
            touch = false
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                socket.emit("shoot");
                charge = 0
            }
    };


    DOM.canvas.addEventListener('touchstart', touchStart, {passive: true}, false);
    DOM.canvas.addEventListener('touchend', touchEnd, {passive: true}, false);


    
    for(let i=-2; i<(room.width/200)+2; i++)
    {
        GAME.Fog(i*200,-180)
        GAME.Fog(i*200,room.height+180)
    }

    for(let i=-2; i<(room.height/200)+2; i++)
    {
        GAME.Fog(-200,i*200)
        GAME.Fog(room.width+200,i*200)
    }

   

    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });

    
    socket.on('hit',function(data)
    {   
        let range = 5*data.num
        for(let i=0; i<data.num; i++)
        {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
    });


    socket.on('playerDie',function(data)
    {   
        let range = 30
        for(let i=0; i<20; i++)
        {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
    });


    socket.on('ballEnd',function(data)
    {   
        GAME.Splash(Math.random(),GAME.Balls.list[data].x,GAME.Balls.list[data].y)
        delete GAME.Balls.list[data]    
    });

    socket.on('disconnection',function(data)
    {  
        delete GAME.Players.list[data];
    });


    socket.on('newPositions',function(data)
    {
           fpsServer = data.fps;
           let lastOwner = -1;
           //aggiorna posizione palle 
            for(let i = 0 ; i < data.balls.length; i++)
            {
                
                let current = data.balls[i];

                if(GAME.Balls.list[current.id] == undefined)
                {          
                    GAME.Balls(current.id,current.x, current.y);
                    console.log(lastOwner+"   "+current.owner)
                    if(SETTINGS.audio == true && lastOwner != current.owner)
                    {
                        let me = GAME.Players.list[id]; 
                        let au = new Audio("client/mp3/sou_cannon.mp3")
                        au.volume = ENGINE.clamp(Math.abs( 1-( ENGINE.clamp(ENGINE.point_distance(me.x,me.y,current.x,current.y),0,1000))/1000 ),0,1)                  
                        au.play();
                    }
                    
                    lastOwner = current.owner

                }
                else
                {            
                    GAME.Balls.list[current.id].x = current.x;
                    GAME.Balls.list[current.id].y = current.y;
                }
            }


            //aggiorna posizione giocatori
            for(let i = 0 ; i < data.players.length; i++)
            {
                let current = data.players[i];

                if(GAME.Players.list[current.id] == undefined)
                {          
                    GAME.Players(current.id, current.x, current.y, current.name, current.angle);
                }
                else
                {            
                    GAME.Players.list[current.id].x = current.x;
                    GAME.Players.list[current.id].y = current.y;
                    GAME.Players.list[current.id].angle = current.angle;
                    GAME.Players.list[current.id].life = current.life;
                    GAME.Players.list[current.id].points = current.points;
                }
            }





            //aggiorna posizione casse 
            for(let i = 0 ; i < data.chests.length; i++)
            {
                let current = data.chests[i];

                if(GAME.Chest.list[current.id] == undefined)
                {          
                    GAME.Chest(current.id,current.x, current.y);
                }
                else
                {            
                    GAME.Chest.list[current.id].x = current.x;
                    GAME.Chest.list[current.id].y = current.y;
                }
            }


    });


   
</script>


</body>


</html>