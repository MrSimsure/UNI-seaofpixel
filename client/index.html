
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">

<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>

<div id="page_login">
    Username: <input id="login_username" type="text"></input>
    <button id="login_button">Logga</button>
</div>

 <div id="page_game" style="display:none">
    <canvas id="canvas" width="480" height="270" style="border:1px solid #000000;"></canvas>
</div>

<script src="/client/virtualjoystick.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/client/load.js"></script>
<script src="/client/game.js"></script>
<script src="/client/init.js"></script>



<script>

    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });

    login_button.onclick = function()
    {
        socket.emit("login", {name:login_username.value});
        page_login.style.display = "none";
        page_game.style.display = "inline-block";

        if(SETTINGS.onMobile == true)
        {
            joystick = new VirtualJoystick(
                        {
                        mouseSupport: true,
                        stationaryBase: true,
                        baseX: 100,
                        baseY: 260,
                        limitStickTravel: true,
                        stickRadius: 50
                        });
        }
    }

    
    document.onkeydown = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:true}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:true}); }
    }
    
    document.onkeyup = function(event)
    {
        if(event.keyCode == 68) //d
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 83) //s
        { socket.emit("keyPress", {id:"down", state:false}); }
         if(event.keyCode == 65) //a
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 87) //w
        { socket.emit("keyPress", {id:"up", state:false}); }
    }    
    
    
   setInterval(function()
   {
        if(SETTINGS.onMobile == true && joystick != null)
        {
            if( joystick.right() )
            { socket.emit("keyPress", {id:"right", state:true}); } else { socket.emit("keyPress", {id:"right", state:false}); }
            if( joystick.left() )
            {  socket.emit("keyPress", {id:"left", state:true});} else {  socket.emit("keyPress", {id:"left", state:false});}
            if( joystick.up() )
            {  socket.emit("keyPress", {id:"up", state:true}); } else {  socket.emit("keyPress", {id:"up", state:false}); }
            if( joystick.down() )
            {  socket.emit("keyPress", {id:"down", state:true}); } else {  socket.emit("keyPress", {id:"down", state:false}); }
        }
   } ,1000/30);  


    socket.on('newPositions',function(data)
    {
        
        //trova il giocatore appartenente a questo client
        for(var i = 0 ; i < data.players.length; i++)
        {
            if(data.players[i].id == id)
            {camera.update(data.players[i].x, data.players[i].y);}
        }
        
        //pulisci il canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        //disegna la mappa
        room.map.draw(ctx, camera.xView, camera.yView);

        //disegna tutti i giocatori
        for(var i = 0 ; i < data.players.length; i++)
        {
                for(var n=0; n<23 ; n++)
                {
                    drawFrame(ctx,stripBoat, n, data.players[i].x-camera.xView,  data.players[i].y-camera.yView-4*n, data.players[i].angle);
                }
                //drawSprite(ctx,sprPlayer, data.players[i].x-camera.xView,  data.players[i].y-camera.yView, 45);
                //ctx.drawImage(sprPlayer, data.players[i].x-camera.xView,  data.players[i].y-camera.yView);
                ctx.fillText(data.players[i].name, data.players[i].x-camera.xView,  data.players[i].y-camera.yView-128);
        }
           
        //disegna tutti i proiettili
        for(var i = 0 ; i < data.bullets.length; i++)
        {
            ctx.fillStyle = "#FF0000";
            ctx.fillRect(data.bullets[i].x-5-camera.xView, data.bullets[i].y-5-camera.yView, 10, 10);     
        }

        //controller.draw();
    });
</script>