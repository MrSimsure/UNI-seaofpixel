<!DOCTYPE html>
<html lang="en">
<link rel="manifest" href="/client/manifest.json">
<meta name="viewport" content="minimal-ui, width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="theme-color" content="#4586ef"/>
<meta name="Description" content="A small JS and HTML5 game about pirates!">

<style> section { position: absolute; top:0; bottom:0; left:0; right:0;overflow: hidden;} </style>

<head>
    <link id="css" rel="stylesheet" type="text/css">
    
    <script src="/client/js/init.js"></script>
    <script src="/client/js/engine.js"></script>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.2/firebase-auth.js"></script>

    <script src="/client/js/setting.js"></script>
    <script src="/client/js/game.js"></script>

</head>

<body  id="container" style ="margin:0; overflow-x:hidden; overflow-y:hidden;">
 
<title>Sea of Pixel</title>

<!--PAGINA INIZIALE-->
<div id="page_init"  style="display:inline; position: absolute;   width: 100%; height: 100%;  z-index:2">
    <label class="title" style="width: 100%; top:10%; font-weight:700;">Vuoi abilitare la musica?</label>

    <div style="display: inline-block;  width: 49%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_on" style=" top:50%;  width:30%;  height:30%;  margin:0 auto;    font-weight:600;">SI</button>
    </div>

    <div style="display: inline-block;  width: 50%; height: 100%;   margin:0 auto;">
        <button class="colButton" id="music_button_off" style="top:50%;  width:30%;  height:30%;    font-weight:600;">NO</button>
    </div>
</div>

<!--PAGINA MENU PRINCIPALE-->
<div id="page_menu"  style="display:none; position: absolute;   width: 100%; height: 100%;  z-index:2;  align-items: center; justify-content: center;">
    
    <label class="title"style="width: 100%; top:5%;  font-weight:700;">SEA OF PIXEL</label>
    <label id ="splash" class="title" style="font-size: 2.0vw; width: 100%; top:13%; font-weight:300;">frase</label>

    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
                


    </div>

    <div style="width: 49%; height: 100%;  margin:0 auto;  align-items: center; justify-content: center;">
        
            <label class="inLabel" id="login_username_label" for="login_username"   style="top:40%; width:50%;display: none">Username</label>
            <input class="inInput" id="login_username"    style="top:40%; width:80%;display: none" type="text"></input>
    
            <label class="inLabel" id="login_email_label"for="login_email"   style="top:45%; width:50%;display: none">Email</label>
            <input class="inInput" id="login_email"    style="top:45%;  width:80%;display: none" type="text"></input>

            <label class="inLabel" id="login_password_label"for="login_password"   style="top:50%; width:50%;display: none">Password</label>
            <input class="inInput" id="login_password"    style="top:50%;  width:80%;display: none" type="text"></input>
    



            <button class="colButton" id="auth_google"    style=" top:50%;  width:80%;  height:10%;   font-weight:400;">ENTRA CON GOOGLE</button>
            <button class="colButton" id="auth_email"     style=" top:50%;  width:80%;  height:10%;   font-weight:400;">ENTRA CON EMAIL</button>
            <button class="colButton" id="auth_quest"     style=" top:50%;  width:80%;  height:10%;   font-weight:400;">ENTRA SENZA REGISTR</button>

            <div style="display: block; position: relative; top:60%; ">    
            <button class="colButton" id="indietro"   style=" left:8%; top:60%;  width:40%;  height:10%;   font-weight:400;  display: none; ">INDIETRO</button>
            <button class="colButton" id="avanti"     style=" left:8%; top:60%;  width:40%;  height:10%;   font-weight:400;  display: none;  ">AVANTI</button>
            </div>

    </div>

    <div style="width: 50%; height: 100%;   margin:0 auto;  align-items: center; justify-content: center;">
        
        <button class="colButton" id="music_button_off" style="visibility:hidden; display:relative; display: block; top:50%;  width:30%;  height:30%;   font-size:15px;   font-weight:600;">test</button>
    </div>
</div>


<!--PAGINA DI GIOCO-->
 <div id="page_game"  style="display:inline; position:relative;  z-index:0">
    <canvas id="canvas" style="  z-index: 1; position:absolute;" width="640" height="480"></canvas>
</div>


<div id="page_pause"  style="display:none; position:relative;  z-index:0">

    <button class="menuButton" id="audio"        style=" top:20%; ">AUDIO</button>
    <button class="menuButton" id="fullscreen"   style=" top:30%; ">FULLSCREEN</button>
    <button class="menuButton" id="logout"       style=" top:40%; ">LOGOUT</button>
    <button class="menuButton" id="back"         style=" top:60%; ">INDIETRO</button>
</div>


<script src="/client/js/load.js"></script>
<script src="/client/js/loop.js"></script>

<script>

    var mainDir = window.location.href
    var moving = false;
    var fpsClient;
    var fpsServer;
    var nearPlayer = 0;
    var nearChest = 0;
    var charge = 0;
    var keys = [];
    keys[32] = false;
    var touch = false;
    var lastTuch = 0;
    var loginType = 0;
    var tuchX = 0;
    var tuchY = 0;

    var config = 
    {
        apiKey: "AIzaSyAX_ecFSz5hGIRMH3dIsn-PlUEdQhWWyvk",
        authDomain: "sea-of-pixel.firebaseapp.com",
        databaseURL: "https://sea-of-pixel.firebaseio.com",
        projectId: "sea-of-pixel",
        storageBucket: "sea-of-pixel.appspot.com",
        messagingSenderId: "400694456140"
    };
    firebase.initializeApp(config);

    if(SETTINGS.audio)
    {DOM.audio.innerHTML  = "AUDIO OFF"}
    else
    {DOM.audio.innerHTML  = "AUDIO ON"}

    initMenu()

    //LOGIN
    DOM.auth_google.onclick = function()
    {   
        loginType = 0;

        
        DOM.auth_email.style.display = "none"
        DOM.auth_google.style.display = "none"
        DOM.auth_guest.style.display = "none"

        DOM.login_username.style.display = "block";
        DOM.login_username_label.style.display = "block";

        DOM.avanti.style.display = "inline-block";
        DOM.indietro.style.display = "inline-block";
            
    }

    DOM.auth_email.onclick = function()
    {  
        loginType = 1;

        DOM.auth_email.style.display = "none"
        DOM.auth_google.style.display = "none"
        DOM.auth_guest.style.display = "none"

        DOM.login_username.style.display = "block";
        DOM.login_password.style.display = "block";
        DOM.login_email.style.display = "block";

        DOM.login_username_label.style.display = "block";
        DOM.login_password_label.style.display = "block";
        DOM.login_email_label.style.display = "block";

        DOM.avanti.style.display = "inline-block";
        DOM.indietro.style.display = "inline-block";
    }



    DOM.auth_guest.onclick = function()
    {  
        loginType = 2;

        DOM.auth_email.style.display = "none"
        DOM.auth_google.style.display = "none"
        DOM.auth_guest.style.display = "none"

        DOM.login_username.style.display = "block";
        DOM.login_username_label.style.display = "block";

        DOM.avanti.style.display = "inline-block";
        DOM.indietro.style.display = "inline-block";

    }


    DOM.indietro.onclick = function()
    {  
        DOM.auth_email.style.display = "block"
        DOM.auth_google.style.display = "block"
        DOM.auth_guest.style.display = "block"

        DOM.login_username.style.display = "none";
        DOM.login_password.style.display = "none";
        DOM.login_email.style.display = "none";

        DOM.login_username_label.style.display = "none";
        DOM.login_password_label.style.display = "none";
        DOM.login_email_label.style.display = "none";

        DOM.avanti.style.display = "none";
        DOM.indietro.style.display = "none";
    }


    DOM.avanti.onclick = function()
    {  

        switch(loginType)
        {
            //LOGIN CON GOOGLE
            case 0 :
            {
                
                var provider = new firebase.auth.GoogleAuthProvider();

                firebase.auth().signInWithPopup(provider).then(function(result) 
                {
                    var token = result.credential.accessToken;
                    var user = result.user;

                }).catch(function(error) 
                {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    var email = error.email;
                    var credential = error.credential;
                });
                break;
            }

            //LOGIN CON EMAIL
            case 1 :
            {
                firebase.auth().signInWithEmailAndPassword(login_email.value, login_password.value).catch(function(error) 
                {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.log("errore nel login = "+errorCode)

                    if(errorCode == "auth/user-not-found")
                    {
                        firebase.auth().createUserWithEmailAndPassword(login_email.value, login_password.value).catch(function(error) 
                        {
                        // Handle Errors here.
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        console.log("errore nella registrazione = "+errorCode)
                        });
                    }

                    if(errorCode == "auth/wrong-password")
                    {
                        //border: 2px solid red;
                        DOM.login_password.style = "top:50%;  width:80%; border: 2px solid red;"
                    }

                    if(errorCode == "auth/invalid-email")
                    {
                        //border: 2px solid red;
                        DOM.login_email.style = "top:45%;  width:80%; border: 2px solid red;"
                    }
                });

                break;
            }

            //LOGIN COME GUEST
            case 2 :
            {
                firebase.auth().signInAnonymously().catch(function(error) 
                {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                console.log("errore nel login = "+errorCode)
                });
                break;
            }

        }

        
    }


    DOM.login_password.onclick = function(){DOM.login_password.style = "top:50%;  width:80%;"}
    DOM.login_email.onclick = function(){DOM.login_email.style = "top:45%;  width:80%;"}

    DOM.logout.onclick = function()
    {
        
        firebase.auth().signOut().then(function() 
        {
            socket.emit("logout");
            SETTINGS.inGame = false

            clearInterval(game_update);
            socket.removeAllListeners("hit")
            socket.removeAllListeners("playerDie")
            socket.removeAllListeners("ballEnd")
            ocket.removeAllListeners("chestEnd")
            socket.removeAllListeners("disconect")
            socket.removeAllListeners("newPositions")
            GAME.clearEntity();
            initMenu()
 

            DOM.login_username.style.display = "none";
            DOM.login_password.style.display = "none";
            DOM.login_email.style.display = "none";

            DOM.login_username_label.style.display = "none";
            DOM.login_password_label.style.display = "none";
            DOM.login_email_label.style.display = "none";
            
            DOM.avanti.style.display = "none";
            DOM.indietro.style.display = "none";

            DOM.auth_email.style.display = "block"
            DOM.auth_google.style.display = "block"
            DOM.auth_guest.style.display = "block"

            DOM.page_pause.style.display = "none";
            DOM.page_menu.style.display = "inline-flex";
            


        }).catch(function(error) 
        {
            console.log("errore nel logout")
        });
    }

    DOM.audio.onclick = function()
    {
        SETTINGS.audio = !SETTINGS.audio

        if(SETTINGS.audio)
        {
            DOM.audio.innerHTML  = "AUDIO OFF"
            LOADER.musMenu.loop = true
            LOADER.musMenu.play()
        }
        else
        {
            DOM.audio.innerHTML  = "AUDIO ON"
            LOADER.musMenu.pause();
        }
    }


    DOM.fullscreen.onclick = function()
    {
        SETTINGS.openFullscreen()
    }

    DOM.back.onclick = function()
    {
        setPause()
    }


    document.onkeydown = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=true;
        
        if(event.keyCode == 16)
        {AUDIO = !AUDIO}

        if(event.keyCode == 68 || event.keyCode == 39) //d 
        { socket.emit("keyPress", {id:"left", state:true}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:true}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:true}); moving = true;}

        if(event.keyCode == 27)
        {setPause()}
    }
    
    document.onkeyup = function(event)
    {
        keys = (keys || []);
        keys[event.keyCode]=false;

        if(event.keyCode == 68 || event.keyCode == 39) //d
        { socket.emit("keyPress", {id:"left", state:false}); }
         if(event.keyCode == 65 || event.keyCode == 37) //a
        { socket.emit("keyPress", {id:"right", state:false}); }
         if(event.keyCode == 87 || event.keyCode == 38) //w
        { socket.emit("keyPress", {id:"up", state:false}); moving = false;}
        if(event.keyCode == 32) //space
        { 
            if(charge < 10) 
            {
                charge = 0
            }
            else
            {
                
                socket.emit("shoot");
                charge = 0
            }
        }
    }    

    function touchStart(ev) 
    {     
        if(SETTINGS.inGame == true)
        {ev.preventDefault()}

        if(ev.touches[0].clientX > screen.width/2   &&  ev.touches[0].clientY > screen.height/2)
        {touch = true}

        if(ev.touches[0].clientX <100 && ev.touches[0].clientY < 100)
        {setPause()}
        
    };
    
    function touchEnd(ev) 
    {       
        tuchX = -1
        tuchY = -1
        touch = false

        if(charge < 10) 
        {
                charge = 0
        }
        else
        {
                socket.emit("shoot");
                charge = 0
        }
    
    };

    function touchMove(ev)
    { 
        tuchX = ev.touches[0].clientX;
        tuchY = ev.touches[0].clientY; 
    }

    window.addEventListener('touchstart', touchStart, {passive: false}, false);
    window.addEventListener('touchend', touchEnd, {passive: false}, false);
    window.addEventListener('touchmove', touchMove, {passive: false}, false);


    //CONNESSIONE
    var acces = function()
    {
            let user = firebase.auth().currentUser;
            let name = "";
            
            if(DOM.login_username.value != "" && DOM.login_username.value != user.displayName)
            {
                name = DOM.login_username.value;
                user.updateProfile({displayName: DOM.login_username.value,}).then(function() {}).catch(function(error) {});
            }
            else
            {name =user.displayName;}

            socket.emit("gameStart",{username:name,  id:user.uid, anonymus:user.isAnonymous})
            initGame();

            socket.on('hit',function(data)
            {   
                let range = 5*data.num
                for(let i=0; i<data.num; i++)
                {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}

                let me = GAME.Players.list[id]; 
                let volume = ENGINE.clamp(Math.abs( 1-( ENGINE.clamp(ENGINE.point_distance(me.x,me.y,data.x,data.y),0,1000))/1000 ),0,1);
                GAME.playAudio(LOADER.souHit,volume);
            });
            socket.on('playerDie',function(data)
            {   
                let range = 30
                for(let i=0; i<20; i++)
                {GAME.Explosion(Math.random(),data.x+ENGINE.random_range(-range,range),data.y+ENGINE.random_range(-range,range))}
            });
            socket.on('ballEnd',function(data)
            {   
                GAME.Splash(Math.random(),GAME.Balls.list[data].x,GAME.Balls.list[data].y)
                delete GAME.Balls.list[data]    
            });
            socket.on('chestEnd',function(data)
            {   
                delete GAME.Chest.list[data]    
            });
            socket.on('disconnection',function(data)
            { 
                delete GAME.Players.list[data];
            });
            socket.on('newPositions',function(data)
            {
                fpsServer = data.fps;
                let lastOwner = -1;
                //aggiorna posizione palle 
                    for(let i = 0 ; i < data.balls.length; i++)
                    {
                        let current = data.balls[i];

                        if(GAME.Balls.list[current.id] == undefined)
                        {          
                            GAME.Balls(current.id,current.x, current.y);

                            if(SETTINGS.audio == true && lastOwner != current.owner)
                            {
                                let me = GAME.Players.list[id]; 
                                let volume = ENGINE.clamp(Math.abs( 1-( ENGINE.clamp(ENGINE.point_distance(me.x,me.y,current.x,current.y),0,1000))/1000 ),0,1);
                                GAME.playAudio(LOADER.souCannon,volume);                 
                            }
                            lastOwner = current.owner;
                        }
                        else
                        {            
                            GAME.Balls.list[current.id].x = current.x;
                            GAME.Balls.list[current.id].y = current.y;
                        }
                    }

                    //aggiorna posizione giocatori
                    for(let i = 0 ; i < data.players.length; i++)
                    {
                        let current = data.players[i];

                        if(GAME.Players.list[current.id] == undefined)
                        {          
                            GAME.Players(current.id, current.x, current.y, current.name, current.angle);
                        }
                        else
                        {            
                            GAME.Players.list[current.id].x = current.x;
                            GAME.Players.list[current.id].y = current.y;
                            GAME.Players.list[current.id].angle = current.angle;
                            GAME.Players.list[current.id].life = current.life;
                            GAME.Players.list[current.id].points = current.points;
                        }
                    }

                    //aggiorna posizione casse 
                    for(let i = 0 ; i < data.chests.length; i++)
                    {
                        let current = data.chests[i];

                        if(GAME.Chest.list[current.id] == undefined)
                        {          
                            GAME.Chest(current.id,current.x, current.y);
                        }
                        else
                        {            
                            GAME.Chest.list[current.id].x = current.x;
                            GAME.Chest.list[current.id].y = current.y;
                        }
                    }
            });
        
    };

    //CONNESSIONE
    socket.on('connection',function(data)
    {    
        id = data
        console.log("my socket id = "+id);
    });

    //fai diventare irreversibilmente il giocatore un bot cheater in grado di muoversi casualente e spararre cannonate infinite
    iAmBot = function()
    {
        mov = function() 
        {
            arr = ["left", "right"];
            i = Math.round(Math.random());
            socket.emit("keyPress", {id: arr[(i+1)%2], state: false});
            socket.emit("keyPress", {id: arr[i], state: true});
        }
        setInterval(mov, 200)
        avanti = () => socket.emit("keyPress", {id:"up", state:(Math.random() >= 0.5)});
        setInterval(avanti, 300)
        spara = () => socket.emit("shoot");
        setInterval(spara,100);
        return "Complimenti, ora sei un bot senza anima ne morale portatore di morte e distruzione"
    }
    


    setPause = function()
    {
        SETTINGS.inGame = !SETTINGS.inGame

        if(SETTINGS.inGame)
        {
            DOM.page_pause.style.display = "none"
        }
        else
        {
            DOM.page_pause.style.display = "inline"
        }
    }


    setLogin = function()
    {
        firebase.auth().onAuthStateChanged(function(user) 
        {
            if (user) 
            {
                console.log("CONNESSO = "+user.displayName+"   "+user.email+"   "+user.uid)            
               acces()
            } 
            else 
            {
                console.log("DISCONNESSO")
            }
        });
    }
    
</script>

</body>

</html>